<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Paper Layout Organizer - Legacy</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.2.0/classList.min.js"></script>
    <style>
        /* -----------------------------------------------
           MAIN THEME REPLACING CSS VARIABLES WITH RAW COLORS
           ----------------------------------------------- */
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f7f9fc; /* was var(--background-color) */
            margin: 0;
            padding: 20px;
            color: #333; /* was var(--text-color) */
        }
        h2 {
            margin: 0 0 10px;
        }

        /* -----------------------------------------------
           CONTROL PANEL
           ----------------------------------------------- */
        #controls {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            /* Basic Flexbox, with fallback for IE11 */
            display: -ms-flexbox;
            display: flex;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        #controls > div {
            /* CHANGED: Give each section some space. */
            margin-right: 40px;
            margin-bottom: 20px;
        }

        /* CHANGED: Add spacing between label/input pairs. */
        #controls label {
            display: inline-block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        /* Let each control be on its own line for clarity. */
        #controls div > div {
            margin-bottom: 10px;
        }

        /* Add margins for inputs so they aren't too close together. */
        input[type="number"],
        input[type="text"],
        select {
            padding: 6px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 8px; /* CHANGED */
            margin-top: 3px;   /* CHANGED */
            margin-bottom: 3px;/* CHANGED */
            width: 100px;
        }
        input[type="text"] {
            width: 150px;
        }
        button {
            padding: 8px 15px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            background: #007bff; /* was var(--primary-color) */
            color: #fff;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 5px;
            display: inline-block;
        }
        button:hover {
            background: #0056b3;
        }

        /* -----------------------------------------------
           PAPER & FRAMES
           ----------------------------------------------- */
        #paper {
            position: relative;
            margin: 0 auto 20px auto;
            background: #ffffff; /* was var(--paper-background) */
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
            width: 800px; /* default inline style */
            height: 600px;/* default inline style */
        }
        .frame {
            position: absolute;
            border: 2px solid #007bff;
            background: rgba(0, 123, 255, 0.1);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            box-sizing: border-box;
            cursor: move;
            transition: box-shadow 0.2s ease;
            transform-origin: center;
        }
        .frame.dragging {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* -----------------------------------------------
           FRAME TRACKER SECTION
           ----------------------------------------------- */
        #frameTracker {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #frameTracker table {
            background: #edf7f7;
            width: 100%;
            border-collapse: collapse;
        }
        #frameTracker th,
        #frameTracker td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            transition: background-color 0.3s;
        }
        #frameTracker th {
            background-color: #f0f0f0;
        }
        .frame-id-cell {
            cursor: text;
        }
        .dim-cell {
            cursor: text;
        }
        .delete-btn {
            background: #dc3545;
            border: none;
            border-radius: 4px;
            color: #fff;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        #deleteAllFrames,
        #undoAction {
            margin-bottom: 10px;
            background: #dc3545;
        }
        #undoAction {
            background: #6c757d;
        }
        #undoAction:hover {
            background: #5a6268;
        }

        /* -----------------------------------------------
           EXTRA STYLES
           ----------------------------------------------- */
        .scale-info {
            font-size: 12px;
            color: #555;
            margin-left: 5px;
        }
        .rotate-slider {
            width: 100px;
            margin-left: 5px; /* CHANGED */
        }
        .rotate-value {
            font-size: 12px;
            margin-left: 5px;
        }
        #paperSizeOutput {
            margin-top: 10px;
            font-size: 14px;
            color: #333;
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            background: #edf7f7;
        }
        .frame-size-display {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(255, 255, 255, 0.7);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            color: #333;
            pointer-events: none;
            white-space: nowrap;
            z-index: 5;
        }
        #toggleFrameSizes {
            margin-left: 10px;
            background: #6c757d;
        }
        #toggleFrameSizes:hover {
            background: #5a6268;
        }
        .alignment-line {
            position: absolute;
            background-color: transparent;
            border: 1px dashed #666;
            pointer-events: none;
            z-index: 2;
        }
        .alignment-line.horizontal {
            height: 0;
            border-top-style: dashed;
            border-bottom: none;
        }
        .alignment-line.vertical {
            width: 0;
            border-left-style: dashed;
            border-right: none;
        }
        #toggleAlignmentLines {
            margin-left: 10px;
            background: #28a745;
        }
        #toggleAlignmentLines:hover {
            background: #218838;
        }
        .line-controls {
            margin-top: 10px;
        }
        .rotation-buttons {
            margin-top: 5px;
        }
        .rotate-btn {
            padding: 2px 5px;
            background-color: #ff5733;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .rotate-btn:hover {
            background-color: #e0e0e0;
        }
        .highlighted-row {
            background-color: #e6f7ff !important;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
        .frame {
            cursor: pointer;
        }
        .draggable {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .frame {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }
        .frame-id-display {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 5px;
            font-size: 12px;
            border-radius: 3px;
            pointer-events: none;
            z-index: 1;
        }

        .frame-size-display {
            /* Keep your existing size display styles */
            top: 5px;
            left: 5px;
        }
        .draggable-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
            cursor: move;
        }

        .panel-header {
            padding: 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            border-radius: 8px 8px 0 0;
        }

        .panel-controls button {
            border: none;
            background: none;
            padding: 0 4px;
            cursor: pointer;
            font-size: 18px;
        }

        .panel-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 16px;
        }

        /* Collapsed state */
        .draggable-panel.collapsed .panel-content {
            display: none;
        }

        .draggable-panel.collapsed {
            min-width: auto;
            width: auto !important;
        }
        .close-btn {
            background-color: red;   /* background color of the button */
            color: black;            /* text (×) color */
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .close-btn:hover {
            background-color: darkred; /* optional: change color on hover */
        }
        .minimize-btn {
            background-color: #f0c330;  /* a yellow-ish color */
            color: black;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .minimize-btn:hover {
            background-color: #d4a700;
        }
        .frame {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
        }

        /* Legacy flexbox for draggable panels */
        .draggable-panel {
            display: -webkit-box;
            -webkit-box-orient: vertical;
        }
        .draggable-panel {
            /* Add initial visibility */
            display: block;
            /* Add transition for smooth show/hide */
            transition: opacity 0.3s ease;
        }

        .draggable-panel.hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="controls">
    <!-- Paper Settings -->
    <div>
        <h2>Paper Settings</h2>
        <h3 style="font-size:14px;">(use only for viewing purposes)</h3>
        <div>
            <label for="paperWidth">Width:</label>
            <input type="number" id="paperWidth" value="32" min="0"/>
        </div>
        <div>
            <label for="paperHeight">Height:</label>
            <input type="number" id="paperHeight" value="24" min="0"/>
        </div>
        <div>
            <label for="paperUnit">Unit:</label>
            <select id="paperUnit">
                <option value="px">px</option>
                <option value="cm">cm</option>
                <option value="mm">mm</option>
                <option value="inch" selected>inch</option>
            </select>
            <span id="paperScaleInfo" class="scale-info"></span>
        </div>
        <button id="setPaperSize">Apply</button>
    </div>

    <!-- Frame Settings -->
    <div>
        <h2>Frame Settings</h2>
        <div>
            <label for="frameName">Frame Name:</label>
            <input type="text" id="frameName" placeholder="Auto-generated if blank" />
        </div>
        <div>
            <label for="frameWidth">Width:</label>
            <input type="number" id="frameWidth" value="10" min="0"/>
        </div>
        <div>
            <label for="frameHeight">Height:</label>
            <input type="number" id="frameHeight" value="5" min="0"/>
        </div>
        <div>
            <label for="frameUnit">Unit:</label>
            <select id="frameUnit">
                <option value="px">px</option>
                <option value="cm">cm</option>
                <option value="mm">mm</option>
                <option value="inch" selected>inch</option>
            </select>
            <span id="frameScaleInfo" class="scale-info"></span>
        </div>
        <button id="addFrame">Add Frame</button>
        <button id="undoAction">Undo Last Frame</button>
    </div>

    <!-- Organize Section -->
    <div>
        <h2>Organize</h2>
        <div>
            <label for="marginInput">Margin:</label>
            <input type="number" id="marginInput" value="0.25" min="0"/>
            <select id="marginUnit">
                <option value="px">px</option>
                <option value="cm">cm</option>
                <option value="mm">mm</option>
                <option value="inch" selected>inch</option>
            </select>
            <span id="marginScaleInfo" class="scale-info"></span>
        </div>
        <div>
            <label>
                <input type="checkbox" id="allowRotation" />
                Allow 90° rotations for optimal packing/cuts
            </label>
        </div>
        <div class="line-controls">
            <button id="organizeBtn">Organize</button>
            <button id="toggleFrameSizes">Show/Hide Sizes</button>
            <button id="toggleAlignmentLines">Show/Hide Alignment Lines</button>
        </div>
        <div id="paperSizeOutput"></div>
    </div>
</div>

<div id="paper"></div>
<div style="position: fixed; top: 300px; left: 40px; z-index: 1000;">
    <button id="frameTrackerToggle" style="padding: 8px 12px; background: #FFA500; border: 1px solid #ccc; cursor: pointer;">
        Show/Hide Frame Tracker
    </button>
</div>
<div id="frameTracker" class="draggable-panel">
    <div class="panel-header">
        <span>Frame Tracker</span>
        <div class="panel-controls">
            <button class="minimize-btn">−</button>
            <button class="close-btn">×</button>
        </div>
    </div>
    <div class="panel-content">
        <button id="deleteAllFrames">Delete All Frames</button>
        <table id="frameList">Drag this box around</table>
    </div>
</div>
<button onclick="testStorage()">Test localStorage</button>
<script>
    function testStorage() {
        try {
            localStorage.setItem('testKey', 'testValue');
            var readBack = localStorage.getItem('testKey');
            alert('We set "testValue" and got back: ' + readBack);
        } catch (e) {
            alert('localStorage error: ' + e.message);
        }
    }
    /* --------------------------------------------------
       KEY GLOBALS & SIMPLE HELPER VARS
       -------------------------------------------------- */
    // CHANGED: set showAlignmentLines to true so alignment lines appear by default
    var showAlignmentLines = true;
    var currentUnit = "inch";

    var conversionFactors = {
        px: 1,
        cm: 10,
        mm: 1,
        inch: 25
    };

    /* --------------------------------------------------
       SCALE INFO
       -------------------------------------------------- */
    function updateScaleInfo() {
        document.getElementById("paperScaleInfo").textContent =
            "Scale: 1 " + currentUnit + " = " + conversionFactors[currentUnit] + " px";
        document.getElementById("frameScaleInfo").textContent =
            "Scale: 1 " + currentUnit + " = " + conversionFactors[currentUnit] + " px";
    }
    function updateMarginScaleInfo() {
        document.getElementById("marginScaleInfo").textContent =
            "Scale: 1 " + currentUnit + " = " + conversionFactors[currentUnit] + " px";
    }
    updateScaleInfo();
    updateMarginScaleInfo();

    /* --------------------------------------------------
       SYNC UNITS
       -------------------------------------------------- */
    function syncUnits(newUnit) {
        if (newUnit === currentUnit) return;
        var oldUnit = currentUnit;
        currentUnit = newUnit;
        var ratio = conversionFactors[oldUnit] / conversionFactors[newUnit];

        // Update paper dims
        var paperWidthInput = document.getElementById("paperWidth");
        var paperHeightInput = document.getElementById("paperHeight");
        var oldPaperWidth = parseFloat(paperWidthInput.value);
        var oldPaperHeight = parseFloat(paperHeightInput.value);
        var actualPaperWidthPx = oldPaperWidth * conversionFactors[oldUnit];
        var actualPaperHeightPx = oldPaperHeight * conversionFactors[oldUnit];
        paperWidthInput.value = actualPaperWidthPx / conversionFactors[newUnit];
        paperHeightInput.value = actualPaperHeightPx / conversionFactors[newUnit];

        var paper = document.getElementById("paper");
        paper.style.width = actualPaperWidthPx + "px";
        paper.style.height = actualPaperHeightPx + "px";

        // Update frame tracker
        var rows = document.querySelectorAll("#frameList tr");
        for (var i = 0; i < rows.length; i++) {
            var row = rows[i];
            var unitCell = row.cells[3];
            unitCell.textContent = newUnit;
            var frameId = row.id.replace("-row", "");
            var frameElem = document.getElementById(frameId);
            if (frameElem) {
                var origWidthPx = parseFloat(frameElem.getAttribute("data-orig-width"));
                var origHeightPx = parseFloat(frameElem.getAttribute("data-orig-height"));
                var newWidthDisplayed = origWidthPx / conversionFactors[newUnit];
                var newHeightDisplayed = origHeightPx / conversionFactors[newUnit];
                row.cells[1].textContent = newWidthDisplayed;
                row.cells[2].textContent = newHeightDisplayed;
            }
        }

        // Update margin
        var marginInput = document.getElementById("marginInput");
        var oldMargin = parseFloat(marginInput.value);
        marginInput.value = oldMargin * ratio;

        document.getElementById("paperUnit").value = newUnit;
        document.getElementById("frameUnit").value = newUnit;
        document.getElementById("marginUnit").value = newUnit;
        updateScaleInfo();
        updateMarginScaleInfo();
        updateAllFrameSizeDisplays();
    }
    var isPanelVisible = true;
    var toggleButton = document.getElementById('frameTrackerToggle');
    var panel = document.getElementById('frameTrackerPanel');

    toggleButton.onclick = function() {
        isPanelVisible = !isPanelVisible;

        if(isPanelVisible) {
            panel.style.display = 'block';
            panel.style.opacity = '1';
            toggleButton.innerHTML = 'Hide Frame Tracker';
            // Force redraw for WebKit
            panel.offsetHeight;
        } else {
            panel.style.opacity = '0';
            // Delay display:none for transition
            setTimeout(function(){
                panel.style.display = 'none';
            }, 300);
            toggleButton.innerHTML = 'Show Frame Tracker';
        }
    };
    // EVENT: Changing units
    document.getElementById("paperUnit").addEventListener("change", function() {
        syncUnits(this.value);
    });
    document.getElementById("frameUnit").addEventListener("change", function() {
        syncUnits(this.value);
    });
    document.getElementById("marginUnit").addEventListener("change", function() {
        syncUnits(this.value);
    });
    // Make panel draggable
    let isDragging = false;
    let currentX = 0;
    let currentY = 0;
    let initialX = 0;
    let initialY = 0;
    let xOffset = 0;
    let yOffset = 0;

    var panel = document.getElementById('frameTracker');
    var header = panel.querySelector('.panel-header');

    header.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);

    function dragStart(e) {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;

        if (e.target === header || header.contains(e.target)) {
            isDragging = true;
        }
    }

    function drag(e) {
        if (isDragging) {
            e.preventDefault();
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;
            xOffset = currentX;
            yOffset = currentY;
            setTranslate(currentX, currentY, panel);
        }
    }

    function setTranslate(xPos, yPos, el) {
        el.style.left = xPos + 'px';
        el.style.top = yPos + 'px';
    }

    function dragEnd() {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
    }

    // Toggle visibility controls
    panel.querySelector('.minimize-btn').addEventListener('click', function() {
        panel.classList.toggle('collapsed');
    });

    panel.querySelector('.close-btn').addEventListener('click', function() {
        panel.style.display = 'none';
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape'){}
    });
    /* --------------------------------------------------
       PAPER & FRAME LOGIC
       -------------------------------------------------- */
    var paper = document.getElementById("paper");
    var frameList = document.getElementById("frameList");
    var frameCount = 0;
    var frameHistory = [];
    // IE11 doesn't have Number.MAX_SAFE_INTEGER
    var MAX_SAFE = 9007199254740991;

    function addFrameDataAttributes(frame, widthPx, heightPx) {
        frame.setAttribute("data-orig-width", widthPx);
        frame.setAttribute("data-orig-height", heightPx);
    }
    function generateUniqueId(base) {
        var id = base;
        var counter = 1;
        while (document.getElementById(id)) {
            id = base + "-" + counter;
            counter++;
        }
        return id;
    }
    function updateFrameId(oldId, newId) {
        var frame = document.getElementById(oldId);
        if (frame) frame.id = newId;
        var row = document.getElementById(oldId + "-row");
        if (row) {
            row.id = newId + "-row";
            var deleteBtn = row.querySelector(".delete-btn");
            if (deleteBtn) {
                deleteBtn.setAttribute("data-frame-id", newId);
            }
            var slider = row.querySelector(".rotate-slider");
            if (slider) {
                slider.setAttribute("data-frame-id", newId);
            }
            var idCell = row.querySelector(".frame-id-cell");
            if (idCell) {
                idCell.setAttribute("data-frame-id", newId);
            }
        }
        var index = frameHistory.indexOf(oldId);
        if (index !== -1) {
            frameHistory[index] = newId;
        }
    }

    /* --------------------------------------------------
       PAPER DIMENSIONS BUTTON
       -------------------------------------------------- */
    document.getElementById("setPaperSize").addEventListener("click", function() {
        var w = parseFloat(document.getElementById("paperWidth").value) || 0;
        var h = parseFloat(document.getElementById("paperHeight").value) || 0;
        var factor = conversionFactors[currentUnit];
        paper.style.width = (w * factor) + "px";
        paper.style.height = (h * factor) + "px";
    });

    /* --------------------------------------------------
       ADD FRAME
       -------------------------------------------------- */
    document.getElementById("addFrame").addEventListener("click", function() {
        var frameNameInput = document.getElementById("frameName").value.replace(/^\s+|\s+$/g, "");
        var frameWidthInput = parseFloat(document.getElementById("frameWidth").value) || 0;
        var frameHeightInput = parseFloat(document.getElementById("frameHeight").value) || 0;
        var factor = conversionFactors[currentUnit];

        frameCount++;
        var baseName = frameNameInput ? frameNameInput : ("frame-" + frameCount);
        var frameId = generateUniqueId(baseName);

        var widthPx = frameWidthInput * factor;
        var heightPx = frameHeightInput * factor;

        // Create DOM element
        var frame = document.createElement("div");
        frame.className = "frame";
        frame.id = frameId;
        frame.style.width = widthPx + "px";
        frame.style.height = heightPx + "px";
        frame.style.left = "0px";
        frame.style.top = "0px";
        frame.style.transform = "rotate(0deg)";
        
        var idDisplay = document.createElement('div');
        idDisplay.className = 'frame-id-display';
        idDisplay.textContent = frameId;
        frame.appendChild(idDisplay);

        paper.appendChild(frame);
        addFrameDataAttributes(frame, widthPx, heightPx);
        makeDraggable(frame);
        frameHistory.push(frameId);

        // Create row in the table
        var row = document.createElement("tr");
        row.id = frameId + "-row";
        row.innerHTML =
            '<td class="frame-id-cell" contenteditable="true" data-frame-id="' + frameId + '">' + frameId + '</td>' +
            '<td class="dim-cell">' + frameWidthInput + '</td>' +
            '<td class="dim-cell">' + frameHeightInput + '</td>' +
            '<td>' + currentUnit + '</td>' +
            '<td>' +
            '  <input type="range" min="0" max="360" value="0" data-frame-id="' + frameId + '" class="rotate-slider">' +
            '  <span class="rotate-value">0°</span>' +
            '  <div class="rotation-buttons">' +
            '    <button class="rotate-btn" data-angle="90" data-frame-id="' + frameId + '">90°</button>' +
            '    <button class="rotate-btn" data-angle="180" data-frame-id="' + frameId + '">180°</button>' +
            '    <button class="rotate-btn" data-angle="270" data-frame-id="' + frameId + '">270°</button>' +
            '  </div>' +
            '</td>' +
            '<td><button class="delete-btn" data-frame-id="' + frameId + '">Delete</button></td>';

        frameList.appendChild(row);

        // ROTATION BUTTONS
        var rotationButtons = row.querySelectorAll(".rotate-btn");
        for (var rb = 0; rb < rotationButtons.length; rb++) {
            rotationButtons[rb].addEventListener("click", function() {
                var angle = parseInt(this.getAttribute("data-angle"), 10);
                var frmId = this.getAttribute("data-frame-id");
                var frm = document.getElementById(frmId);
                if (frm) {
                    frm.style.transform = "rotate(" + angle + "deg)";
                }
                var slider = row.querySelector(".rotate-slider");
                var rotateValue = row.querySelector(".rotate-value");
                slider.value = angle;
                rotateValue.textContent = angle + "°";
                if (showAlignmentLines) {
                    setTimeout(function() {
                        generateAlignmentLines();
                    }, 100);
                }
            });
        }

        // DELETE BUTTON
        var deleteBtn = row.querySelector(".delete-btn");
        deleteBtn.addEventListener("click", function() {
            var currentFrameId = this.getAttribute("data-frame-id");
            deleteFrame(currentFrameId);
        });

        // SLIDER (CHANGED: also listen for 'change' for older browsers)
        var rotateSlider = row.querySelector(".rotate-slider");
        var rotateValue = row.querySelector(".rotate-value");
        function onSliderMove(e) {
            var angle = e.target.value;
            frame.style.transform = "rotate(" + angle + "deg)";
            rotateValue.textContent = angle + "°";
        }
        rotateSlider.addEventListener("input", onSliderMove);
        rotateSlider.addEventListener("change", onSliderMove);

        // ID cell editing
        var idCell = row.querySelector(".frame-id-cell");
        idCell.addEventListener("blur", function() {
            var oldId = this.getAttribute("data-frame-id");
            var newIdCandidate = this.textContent.replace(/^\s+|\s+$/g, "");
            if (newIdCandidate && newIdCandidate !== oldId) {
                var uniqueId = generateUniqueId(newIdCandidate);
                this.textContent = uniqueId;
                updateFrameId(oldId, uniqueId);
            } else if (!newIdCandidate) {
                this.textContent = oldId;
            }
        });

        // Width & height cells
        var widthCell = row.cells[1];
        var heightCell = row.cells[2];
        widthCell.contentEditable = "true";
        heightCell.contentEditable = "true";
        widthCell.addEventListener("keypress", allowOnlyNumbers);
        heightCell.addEventListener("keypress", allowOnlyNumbers);
        widthCell.addEventListener("paste", filterPaste);
        heightCell.addEventListener("paste", filterPaste);

        widthCell.addEventListener("blur", function() {
            var newWidth = parseFloat(this.textContent);
            if (!isNaN(newWidth)) {
                var newWidthPx = newWidth * conversionFactors[currentUnit];
                var frameElem = document.getElementById(row.id.replace("-row", ""));
                if (frameElem) {
                    frameElem.style.width = newWidthPx + "px";
                    frameElem.setAttribute("data-orig-width", newWidthPx);
                    updateFrameSizeDisplay(frameElem);
                }
            } else {
                this.textContent = frameWidthInput;
            }
            saveState();
        });
        heightCell.addEventListener("blur", function() {
            var newHeight = parseFloat(this.textContent);
            if (!isNaN(newHeight)) {
                var newHeightPx = newHeight * conversionFactors[currentUnit];
                var frameElem = document.getElementById(row.id.replace("-row", ""));
                if (frameElem) {
                    frameElem.style.height = newHeightPx + "px";
                    frameElem.setAttribute("data-orig-height", newHeightPx);
                    updateFrameSizeDisplay(frameElem);
                }
            } else {
                this.textContent = frameHeightInput;
            }
        });

        updateFrameSizeDisplay(frame);
        saveState();
    });

    /* --------------------------------------------------
       INPUT FIELD FILTERS
       -------------------------------------------------- */
    function allowOnlyNumbers(e) {
        if (e.ctrlKey || e.metaKey || e.altKey) return;
        if (e.key === "ArrowLeft" || e.key === "ArrowRight" || e.key === "Backspace" || e.key === "Delete") return;
        var currentValue = e.target.textContent || "";
        if (e.key === "-" || e.key === "–") {
            e.preventDefault();
            return;
        }
        if (/[0-9]/.test(e.key)) return;
        if (e.key === "." && currentValue.indexOf(".") === -1) return;
        e.preventDefault();
    }
    function filterPaste(e) {
        e.preventDefault();
        var text = (e.clipboardData || window.clipboardData).getData("text");
        var filtered = text.replace(/[^0-9.]/g, "");
        document.execCommand("insertText", false, filtered);
    }

    /* --------------------------------------------------
       DELETE FRAME
       -------------------------------------------------- */
    function deleteFrame(frameId) {
        var frame = document.getElementById(frameId);
        if (frame && frame.parentNode) {
            frame.parentNode.removeChild(frame);
        }
        var row = document.getElementById(frameId + "-row");
        if (row && row.parentNode) {
            row.parentNode.removeChild(row);
        }
        var newHist = [];
        for (var i = 0; i < frameHistory.length; i++) {
            if (frameHistory[i] !== frameId) {
                newHist.push(frameHistory[i]);
            }
        }
        frameHistory = newHist;
        setTimeout(function() {
            generateAlignmentLines();
        }, 100);
        saveState();
    }

    /* --------------------------------------------------
       DELETE ALL FRAMES
       -------------------------------------------------- */
    document.getElementById("deleteAllFrames").addEventListener("click", function() {
        while (paper.firstChild) {
            paper.removeChild(paper.firstChild);
        }
        frameList.innerHTML = "";
        frameHistory = [];
        frameCount = 0;
        clearAlignmentLines();
        saveState();
    });

    /* --------------------------------------------------
       UNDO LAST
       -------------------------------------------------- */
    document.getElementById("undoAction").addEventListener("click", function() {
        if (frameHistory.length > 0) {
            var lastFrameId = frameHistory.pop();
            deleteFrame(lastFrameId);
        } else {
            alert("No actions to undo.");
        }
        saveState();
    });

    /* --------------------------------------------------
       ORGANIZE BUTTON
       -------------------------------------------------- */
    document.getElementById("organizeBtn").addEventListener("click", function() {
        organizeFrames();
        // CHANGED: If showAlignmentLines is true, we generate lines automatically
        if (showAlignmentLines) {
            generateAlignmentLines();
            generateCuttingGuidelines();
        }
        saveState();
    });

    /* --------------------------------------------------
       ORGANIZE FRAMES ALGORITHM
       (same "maximal rectangles" from earlier)
       -------------------------------------------------- */
    function organizeFrames() {
        var marginInputVal = parseFloat(document.getElementById("marginInput").value) || 0;
        var margin = marginInputVal * conversionFactors[currentUnit];
        var allowRotation = document.getElementById("allowRotation").checked;

        // Gather frames
        var frameElements = document.getElementsByClassName("frame");
        var frames = [];
        var i;
        for (i = 0; i < frameElements.length; i++) {
            var frm = frameElements[i];
            var origW = parseFloat(frm.getAttribute("data-orig-width"));
            var origH = parseFloat(frm.getAttribute("data-orig-height"));
            frames.push({
                element: frm,
                origWidth: origW,
                origHeight: origH,
                rawWidth: origW,
                rawHeight: origH
            });
        }

        // Sort frames by area desc
        frames.sort(function(a, b) {
            return (b.origWidth * b.origHeight) - (a.origWidth * a.origHeight);
        });

        // We’ll replace Number.MAX_SAFE_INTEGER with MAX_SAFE
        function maximalRectanglesPacking(binWidth) {
            var layoutFrames = [];
            for (i = 0; i < frames.length; i++) {
                // deep copy
                layoutFrames.push({
                    element: frames[i].element,
                    origWidth: frames[i].origWidth,
                    origHeight: frames[i].origHeight,
                    rawWidth: frames[i].rawWidth,
                    rawHeight: frames[i].rawHeight
                });
            }

            // single free rectangle
            var freeRectangles = [{
                x: margin,
                y: margin,
                width: binWidth - 2*margin,
                height: MAX_SAFE
            }];

            var binHeight = margin;
            var maxRightEdge = margin;

            // place each frame
            var j;
            for (j = 0; j < layoutFrames.length; j++) {
                var frameObj = layoutFrames[j];
                var placement = findBestPlacement(frameObj, freeRectangles, allowRotation, margin);
                if (placement) {
                    frameObj.posX = placement.x;
                    frameObj.posY = placement.y;
                    frameObj.usedWidth = placement.width;
                    frameObj.usedHeight = placement.height;
                    frameObj.rotated = placement.rotated;

                    binHeight = Math.max(binHeight, placement.y + placement.height + margin);
                    maxRightEdge = Math.max(maxRightEdge, placement.x + placement.width + margin);

                    placeRectangle({
                        x: placement.x - margin,
                        y: placement.y - margin,
                        width: placement.width + 2*margin,
                        height: placement.height + 2*margin
                    }, freeRectangles);
                } else {
                    // no placement found -> place at bottom
                    frameObj.posX = margin;
                    frameObj.posY = binHeight;
                    frameObj.usedWidth = frameObj.origWidth;
                    frameObj.usedHeight = frameObj.origHeight;
                    frameObj.rotated = false;

                    maxRightEdge = Math.max(maxRightEdge, margin + frameObj.origWidth + margin);
                    binHeight += frameObj.origHeight + margin;

                    if (frameObj.origWidth + 2*margin < binWidth - 2*margin) {
                        freeRectangles.push({
                            x: margin + frameObj.origWidth + margin,
                            y: frameObj.posY - margin,
                            width: binWidth - 2*margin - (frameObj.origWidth + margin),
                            height: frameObj.origHeight + 2*margin
                        });
                    }
                }
            }

            var actualNeededWidth = Math.min(binWidth, maxRightEdge);
            return {
                usedWidth: actualNeededWidth,
                usedHeight: binHeight,
                layoutFrames: layoutFrames
            };
        }

        function findBestPlacement(frameObj, freeRects, allowRotation, margin) {
            var bestScore = -Infinity;
            var bestRect = null;
            var bestRotated = false;
            var method = "best-short-side-fit";

            var i;
            for (i = 0; i < freeRects.length; i++) {
                var rect = freeRects[i];
                // normal orientation
                if (frameObj.origWidth <= rect.width && frameObj.origHeight <= rect.height) {
                    var sc = scoreRectangle(rect.width, rect.height, frameObj.origWidth, frameObj.origHeight, method);
                    if (sc > bestScore) {
                        bestScore = sc;
                        bestRect = rect;
                        bestRotated = false;
                    }
                }
                // rotated
                if (allowRotation && frameObj.origHeight <= rect.width && frameObj.origWidth <= rect.height) {
                    var sc2 = scoreRectangle(rect.width, rect.height, frameObj.origHeight, frameObj.origWidth, method);
                    if (sc2 > bestScore) {
                        bestScore = sc2;
                        bestRect = rect;
                        bestRotated = true;
                    }
                }
            }
            if (bestRect) {
                var w = bestRotated ? frameObj.origHeight : frameObj.origWidth;
                var h = bestRotated ? frameObj.origWidth : frameObj.origHeight;
                return {
                    x: bestRect.x,
                    y: bestRect.y,
                    width: w,
                    height: h,
                    rotated: bestRotated
                };
            }
            return null;
        }

        function scoreRectangle(rw, rh, fw, fh, method) {
            var areaFit = rw * rh - fw * fh;
            if (method === "best-area-fit") {
                return -areaFit;
            } else if (method === "best-short-side-fit") {
                var leftoverW = rw - fw;
                var leftoverH = rh - fh;
                var shortSide = leftoverW < leftoverH ? leftoverW : leftoverH;
                return -shortSide;
            } else if (method === "best-long-side-fit") {
                var leftoverW2 = rw - fw;
                var leftoverH2 = rh - fh;
                var longSide = leftoverW2 > leftoverH2 ? leftoverW2 : leftoverH2;
                return -longSide;
            }
            return -areaFit;
        }

        function placeRectangle(placement, freeRects) {
            var newFree = [];
            var i;
            for (i = 0; i < freeRects.length; i++) {
                var free = freeRects[i];
                // no overlap
                if (placement.x + placement.width <= free.x ||
                    placement.x >= free.x + free.width ||
                    placement.y + placement.height <= free.y ||
                    placement.y >= free.y + free.height) {
                    newFree.push(free);
                    continue;
                }
                // overlap -> split

                // left
                if (placement.x > free.x) {
                    newFree.push({
                        x: free.x,
                        y: free.y,
                        width: placement.x - free.x,
                        height: free.height
                    });
                }
                // right
                if (free.x + free.width > placement.x + placement.width) {
                    newFree.push({
                        x: placement.x + placement.width,
                        y: free.y,
                        width: (free.x + free.width) - (placement.x + placement.width),
                        height: free.height
                    });
                }
                // above
                if (placement.y > free.y) {
                    newFree.push({
                        x: free.x,
                        y: free.y,
                        width: free.width,
                        height: placement.y - free.y
                    });
                }
                // below
                if (free.y + free.height > placement.y + placement.height) {
                    newFree.push({
                        x: free.x,
                        y: placement.y + placement.height,
                        width: free.width,
                        height: (free.y + free.height) - (placement.y + placement.height)
                    });
                }
            }
            freeRects.length = 0;

            // remove contained rectangles
            var k;
            for (k = 0; k < newFree.length; k++) {
                var candidate = newFree[k];
                var contained = false;
                var m;
                for (m = 0; m < newFree.length; m++) {
                    if (m === k) { continue; }
                    var other = newFree[m];
                    if (candidate.x >= other.x &&
                        candidate.y >= other.y &&
                        candidate.x + candidate.width <= other.x + other.width &&
                        candidate.y + candidate.height <= other.y + other.height) {
                        contained = true;
                        break;
                    }
                }
                if (!contained) {
                    freeRects.push(candidate);
                }
            }
            mergeFreeRectangles(freeRects);
        }

        function mergeFreeRectangles(freeRects) {
            // Sort by area desc
            freeRects.sort(function(a, b) {
                return (b.width * b.height) - (a.width * a.height);
            });
            var i, j;
            for (i = 0; i < freeRects.length; i++) {
                var rect = freeRects[i];
                for (j = i + 1; j < freeRects.length; j++) {
                    var other = freeRects[j];
                    if (other.x >= rect.x &&
                        other.y >= rect.y &&
                        other.x + other.width <= rect.x + rect.width &&
                        other.y + other.height <= rect.y + rect.height) {
                        freeRects.splice(j, 1);
                        j--;
                    }
                }
            }
        }

        var paperWpx = parseFloat(document.getElementById("paperWidth").value) * conversionFactors[currentUnit];
        var paperHpx = parseFloat(document.getElementById("paperHeight").value) * conversionFactors[currentUnit];

        var normalResult = maximalRectanglesPacking(paperWpx);
        var normalArea = normalResult.usedWidth * normalResult.usedHeight;
        var swappedResult = maximalRectanglesPacking(paperHpx);
        var swappedArea = swappedResult.usedWidth * swappedResult.usedHeight;

        var finalLayout, finalWpx, finalHpx;
        if (swappedArea < normalArea) {
            finalLayout = swappedResult.layoutFrames;
            finalWpx = swappedResult.usedWidth;
            finalHpx = swappedResult.usedHeight;
        } else {
            finalLayout = normalResult.layoutFrames;
            finalWpx = normalResult.usedWidth;
            finalHpx = normalResult.usedHeight;
        }

        var l;
        for (l = 0; l < finalLayout.length; l++) {
            var f = finalLayout[l];
            var element = frames[l].element;
            if (f.rotated) {
                // rotate 90
                element.style.width = f.usedHeight + "px";
                element.style.height = f.usedWidth + "px";
                element.style.left = f.posX + "px";
                element.style.top = f.posY + "px";
                element.style.transformOrigin = "top left";
                element.style.transform = "rotate(90deg) translate(0, -100%)";

                var rowId = element.id + "-row";
                var rowEl = document.getElementById(rowId);
                if (rowEl) {
                    rowEl.cells[1].textContent = (f.usedHeight / conversionFactors[currentUnit]).toFixed(2);
                    rowEl.cells[2].textContent = (f.usedWidth / conversionFactors[currentUnit]).toFixed(2);
                    rowEl.cells[4].querySelector(".rotate-value").textContent = "90°";
                    rowEl.cells[4].querySelector(".rotate-slider").value = 90;
                }
            } else {
                element.style.width = f.usedWidth + "px";
                element.style.height = f.usedHeight + "px";
                element.style.left = f.posX + "px";
                element.style.top = f.posY + "px";
                element.style.transform = "rotate(0deg)";
                element.style.transformOrigin = "center";

                var rowId2 = element.id + "-row";
                var rowEl2 = document.getElementById(rowId2);
                if (rowEl2) {
                    rowEl2.cells[4].querySelector(".rotate-value").textContent = "0°";
                    rowEl2.cells[4].querySelector(".rotate-slider").value = 0;
                }
            }
        }

        paper.style.width = finalWpx + "px";
        paper.style.height = finalHpx + "px";

        var displayedW = finalWpx / conversionFactors[currentUnit];
        var displayedH = finalHpx / conversionFactors[currentUnit];
        var paperSizeOutput = document.getElementById("paperSizeOutput");
        paperSizeOutput.textContent = "Paper Size: " + displayedW.toFixed(2) + " " + currentUnit
            + " x " + displayedH.toFixed(2) + " " + currentUnit;

        // update displays
        updateAllFrameSizeDisplays();
        setTimeout(function() {
            generateAlignmentLines();
        }, 100);
    }

    /* --------------------------------------------------
       NUMBERIC INPUT SAFEGUARDS
       -------------------------------------------------- */
    document.addEventListener('DOMContentLoaded', function() {
        var numericInputs = document.querySelectorAll('input[type="number"]');
        for (var i = 0; i < numericInputs.length; i++) {
            var inp = numericInputs[i];
            inp.setAttribute('min', '0');
            inp.addEventListener('input', function() {
                if (this.value < 0) {
                    this.value = 0;
                }
            });
            inp.addEventListener('keydown', function(e) {
                if (e.key === '-' || e.key === 'e') {
                    e.preventDefault();
                }
            });
        }
    });

    /* --------------------------------------------------
       FRAME SIZE LABELS
       -------------------------------------------------- */
    var showFrameSizes = true;
    function updateFrameSizeDisplay(frame) {
        var widthPx = parseFloat(frame.style.width);
        var heightPx = parseFloat(frame.style.height);
        var widthInUnit = (widthPx / conversionFactors[currentUnit]).toFixed(2);
        var heightInUnit = (heightPx / conversionFactors[currentUnit]).toFixed(2);

        var sizeDisplay = frame.querySelector('.frame-size-display');
        if (!sizeDisplay && showFrameSizes) {
            sizeDisplay = document.createElement('div');
            sizeDisplay.className = 'frame-size-display';
            frame.appendChild(sizeDisplay);
        }
        if (sizeDisplay) {
            sizeDisplay.textContent = widthInUnit + " × " + heightInUnit + " " + currentUnit;
            sizeDisplay.style.display = showFrameSizes ? 'block' : 'none';

            // If 90deg rotation, offset
            var transform = frame.style.transform;
            if (transform.indexOf("rotate(90deg)") !== -1) {
                sizeDisplay.style.transform = "rotate(-90deg)";
                sizeDisplay.style.transformOrigin = "left top";
                sizeDisplay.style.top = "50%";
                sizeDisplay.style.left = "10px";
            } else {
                sizeDisplay.style.transform = "";
                sizeDisplay.style.top = "5px";
                sizeDisplay.style.left = "5px";
            }
        }
        var idDisplay = frame.querySelector('.frame-id-display');
        if (idDisplay) {
            idDisplay.textContent = frame.id;
            if (transform.indexOf("rotate(90deg)") !== -1) {
                idDisplay.style.transform = "rotate(-90deg)";
                idDisplay.style.transformOrigin = "left bottom";
                idDisplay.style.bottom = "50%";
                idDisplay.style.left = "10px";
            } else {
                idDisplay.style.transform = "";
                idDisplay.style.bottom = "5px";
                idDisplay.style.left = "5px";
            }
        }
    }
    function updateAllFrameSizeDisplays() {
        var frames = document.querySelectorAll(".frame");
        for (var i = 0; i < frames.length; i++) {
            updateFrameSizeDisplay(frames[i]);
        }
    }
    function toggleFrameSizes() {
        showFrameSizes = !showFrameSizes;
        updateAllFrameSizeDisplays();
    }
    document.getElementById("toggleFrameSizes").addEventListener("click", function() {
        toggleFrameSizes();
    });
    var toggleBtn = document.getElementById("toggleFrameSizes");
    if (toggleBtn) {
        toggleBtn.addEventListener("click", function() {
            toggleFrameSizes();
        });
    }
    /* --------------------------------------------------
       ALIGNMENT LINES
       -------------------------------------------------- */
    var alignmentLinesSvgId = "guidelinesSvg";
    function clearAlignmentLines() {
        var lines = document.querySelectorAll(".alignment-line");
        for (var i = 0; i < lines.length; i++) {
            if (lines[i].parentNode) {
                lines[i].parentNode.removeChild(lines[i]);
            }
        }
        var svg = document.getElementById(alignmentLinesSvgId);
        if (svg && svg.parentNode) {
            svg.parentNode.removeChild(svg);
        }
    }
    function createAlignmentLine(start, end, orientation) {
        var line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", start.x);
        line.setAttribute("y1", start.y);
        line.setAttribute("x2", end.x);
        line.setAttribute("y2", end.y);
        line.setAttribute("stroke", "#666");
        line.setAttribute("stroke-width", "1");
        line.setAttribute("stroke-dasharray", "3,3");
        line.setAttribute("class", "alignment-line");

        var svg = document.getElementById(alignmentLinesSvgId);
        if (!svg) {
            svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.id = alignmentLinesSvgId;
            svg.style.position = "absolute";
            svg.style.top = "0";
            svg.style.left = "0";
            svg.style.width = "100%";
            svg.style.height = "100%";
            svg.style.pointerEvents = "none";
            svg.style.zIndex = "10";
            paper.appendChild(svg);
        }
        svg.appendChild(line);
    }
    function generateAlignmentLines() {
        if (!showAlignmentLines) {
            return;
        }
        clearAlignmentLines();
        var frames = document.querySelectorAll(".frame");
        if (frames.length < 2) {
            return;
        }
        // Basic approach: lines at each frame edge
        var paperRect = paper.getBoundingClientRect();
        var frameRects = [];
        for (var i = 0; i < frames.length; i++) {
            var rect = frames[i].getBoundingClientRect();
            frameRects.push({
                left: rect.left - paperRect.left,
                right: rect.right - paperRect.left,
                top: rect.top - paperRect.top,
                bottom: rect.bottom - paperRect.top
            });
        }
        // Collect unique X & Y
        var xPositions = [];
        var yPositions = [];
        for (i = 0; i < frameRects.length; i++) {
            xPositions.push(frameRects[i].left, frameRects[i].right);
            yPositions.push(frameRects[i].top, frameRects[i].bottom);
        }
        xPositions.sort(function(a,b){return a-b;});
        yPositions.sort(function(a,b){return a-b;});

        var pWidth = parseInt(paper.style.width,10) || paper.clientWidth;
        var pHeight = parseInt(paper.style.height,10) || paper.clientHeight;

        // Horizontal lines
        function canDrawHorizontal(y) {
            for (var j=0; j<frameRects.length; j++){
                if (y > frameRects[j].top && y < frameRects[j].bottom){
                    return false;
                }
            }
            return true;
        }
        for (var hy=0; hy<yPositions.length; hy++){
            var yVal = yPositions[hy];
            if (canDrawHorizontal(yVal)){
                createAlignmentLine({x:0, y:yVal}, {x:pWidth, y:yVal}, "horizontal");
            }
        }

        // Vertical lines
        function canDrawVertical(x) {
            for (var j=0; j<frameRects.length; j++){
                if (x > frameRects[j].left && x < frameRects[j].right){
                    return false;
                }
            }
            return true;
        }
        for (var vx=0; vx<xPositions.length; vx++){
            var xVal = xPositions[vx];
            if (canDrawVertical(xVal)){
                createAlignmentLine({x:xVal, y:0}, {x:xVal, y:pHeight}, "vertical");
            }
        }
    }
    function generateCuttingGuidelines(){
        var oldCuts = document.querySelectorAll(".cutting-guide");
        for (var i=0; i<oldCuts.length; i++){
            if (oldCuts[i].parentNode){
                oldCuts[i].parentNode.removeChild(oldCuts[i]);
            }
        }
        var frames = document.querySelectorAll(".frame");
        var paperRect = paper.getBoundingClientRect();
        var marginSize = parseFloat(document.getElementById("marginInput").value);
        var halfMargin = marginSize / 2;

        var frameRects = [];
        for (i = 0; i < frames.length; i++) {
            var rect = frames[i].getBoundingClientRect();
            frameRects.push({
                left: rect.left - paperRect.left,
                right: rect.right - paperRect.left,
                top: rect.top - paperRect.top,
                bottom: rect.bottom - paperRect.top
            });
        }
        for (i = 0; i < frameRects.length; i++) {
            var r = frameRects[i];
            createCutLine({ x: r.left - halfMargin, y: r.top - halfMargin },
                { x: r.right + halfMargin, y: r.top - halfMargin });
            createCutLine({ x: r.right + halfMargin, y: r.top - halfMargin },
                { x: r.right + halfMargin, y: r.bottom + halfMargin });
            createCutLine({ x: r.left - halfMargin, y: r.bottom + halfMargin },
                { x: r.right + halfMargin, y: r.bottom + halfMargin });
            createCutLine({ x: r.left - halfMargin, y: r.top - halfMargin },
                { x: r.left - halfMargin, y: r.bottom + halfMargin });
        }
    }

    function createCutLine(start, end) {
        var line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", start.x);
        line.setAttribute("y1", start.y);
        line.setAttribute("x2", end.x);
        line.setAttribute("y2", end.y);
        line.setAttribute("stroke", "red");
        line.setAttribute("stroke-width", "1");
        line.setAttribute("stroke-dasharray", "3,3");
        line.setAttribute("class", "cutting-guide");
        var svg = document.getElementById(alignmentLinesSvgId);
        if (!svg) {
            svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.id = alignmentLinesSvgId;
            svg.style.position = "absolute";
            svg.style.top = "0";
            svg.style.left = "0";
            svg.style.width = "100%";
            svg.style.height = "100%";
            svg.style.pointerEvents = "none";
            svg.style.zIndex = "10";
            paper.appendChild(svg);
        }
        svg.appendChild(line);
    }

    /* --------------------------------------------------
       MAKE DRAGGABLE
       -------------------------------------------------- */
    function makeDraggable(element) {
        var initialX, initialY;
        element.addEventListener("mousedown", dragStart);
        document.addEventListener("mouseup", dragEnd);
        document.addEventListener("mousemove", drag);

        element.addEventListener("click", function(e) {
            e.stopPropagation();
            if (!element.classList.contains("dragging")) {
                highlightFrameRow(element.id);
            }
        });

        function dragStart(e) {
            e.preventDefault();
            initialX = e.clientX - parseInt(element.style.left || "0", 10);
            initialY = e.clientY - parseInt(element.style.top || "0", 10);
            if (element.className.indexOf("dragging") === -1) {
                element.className += " dragging";
            }
            element.style.zIndex = 1000;
            e.stopPropagation();
        }
        function drag(e) {
            if (element.className.indexOf("dragging") !== -1) {
                var newX = e.clientX - initialX;
                var newY = e.clientY - initialY;
                if (newX < 0) newX = 0;
                if (newY < 0) newY = 0;

                element.style.left = newX + "px";
                element.style.top = newY + "px";
                var isRotated = (element.style.transform.indexOf("rotate(90deg)") !== -1);
                var frameWidth = isRotated ? element.offsetHeight : element.offsetWidth;
                var frameHeight = isRotated ? element.offsetWidth : element.offsetHeight;

                var rightEdge = newX + frameWidth;
                var bottomEdge = newY + frameHeight;
                var currentPaperWidth = paper.clientWidth;
                var currentPaperHeight = paper.clientHeight;

                if (rightEdge > currentPaperWidth || bottomEdge > currentPaperHeight) {
                    var newWidth = Math.max(currentPaperWidth, rightEdge + 2);
                    var newHeight = Math.max(currentPaperHeight, bottomEdge + 2);
                    paper.style.width = newWidth + "px";
                    paper.style.height = newHeight + "px";
                }
                optimizePaperSize();
                updatePaperSizeDisplay();
            }
        }
        function dragEnd() {
            element.className = element.className.replace(" dragging", "");
            element.style.zIndex = "";
            updateFrameSizeDisplay(element);
            optimizePaperSize();
            setTimeout(function(){
                generateAlignmentLines();
            }, 100);
            updatePaperSizeDisplay();
            highlightFrameRow(element.id);
            saveState();
        }
        function highlightFrameRow(frameId) {
            var allRows = document.querySelectorAll("#frameList tr");
            for (var i=0; i<allRows.length; i++){
                allRows[i].className = allRows[i].className.replace("highlighted-row", "");
            }
            var rowToHighlight = document.getElementById(frameId + "-row");
            if (rowToHighlight) {
                rowToHighlight.classList.add("highlighted-row");
            }
        }
        function optimizePaperSize() {
            var frames = document.querySelectorAll(".frame");
            var maxRight = 0, maxBottom = 0;
            for (var i=0; i<frames.length; i++){
                var fr = frames[i];
                var rotated = (fr.style.transform.indexOf("rotate(90deg)") !== -1);
                var fw = rotated ? fr.offsetHeight : fr.offsetWidth;
                var fh = rotated ? fr.offsetWidth : fr.offsetHeight;
                var fl = parseInt(fr.style.left||"0",10);
                var ft = parseInt(fr.style.top||"0",10);
                maxRight = Math.max(maxRight, fl + fw);
                maxBottom = Math.max(maxBottom, ft + fh);
            }
            maxRight += 2;
            maxBottom += 2;
            var newW = Math.max(100, maxRight);
            var newH = Math.max(100, maxBottom);
            paper.style.width = newW + "px";
            paper.style.height = newH + "px";
        }
        function updatePaperSizeDisplay() {
            var factor = conversionFactors[currentUnit];
            var pW = paper.clientWidth;
            var pH = paper.clientHeight;
            var displayedW = pW / factor;
            var displayedH = pH / factor;
            var paperSizeOutput = document.getElementById("paperSizeOutput");
            paperSizeOutput.textContent =
                "Paper Size: " + displayedW.toFixed(2) + " " + currentUnit +
                " x " + displayedH.toFixed(2) + " " + currentUnit;
        }
    }

    /* --------------------------------------------------
       INITIALIZE
       -------------------------------------------------- */
    window.addEventListener("resize", function() {
        if (showAlignmentLines) {
            clearAlignmentLines();
            setTimeout(function(){
                generateAlignmentLines();
            }, 100);
        }
    });
    document.addEventListener("DOMContentLoaded", function(){
        setTimeout(function(){
            generateAlignmentLines();
        }, 500);
    });

    document.getElementById("toggleFrameSizes").addEventListener("click", function() {
        toggleFrameSizes();
    });

    document.getElementById("toggleAlignmentLines").addEventListener("click", function() {
        showAlignmentLines = !showAlignmentLines;
        if (showAlignmentLines) {
            generateAlignmentLines();
            generateCuttingGuidelines();
        } else {
            clearAlignmentLines();
            var cuts = document.querySelectorAll(".cutting-guide");
            var i;
            for (i = 0; i < cuts.length; i++) {
                if (cuts[i].parentNode) {
                    cuts[i].parentNode.removeChild(cuts[i]);
                }
            }
        }
    });
    /* -----------------------------------------
       1) SAFE LOCALSTORAGE FUNCTIONS
       ----------------------------------------- */
    function safeSetLocalStorage(key, value) {
        try {
            localStorage.setItem(key, value);
        } catch (e) {
            // If localStorage is blocked/unsupported, do nothing or log
            // console.log("localStorage setItem failed: " + e.message);
        }
    }

    function safeGetLocalStorage(key) {
        try {
            return localStorage.getItem(key);
        } catch (e) {
            // console.log("localStorage getItem failed: " + e.message);
            return null;
        }
    }

    /* -----------------------------------------
       2) SAVE STATE (ES5 Style)
       ----------------------------------------- */
    function saveState() {
        // Use "var" instead of "const"
        var data = {};

        // Basic global flags/vars
        data.showAlignmentLines = showAlignmentLines;
        data.currentUnit = currentUnit;

        // Paper & margin dimensions
        data.paperWidth = document.getElementById("paperWidth").value;
        data.paperHeight = document.getElementById("paperHeight").value;
        data.marginInput = document.getElementById("marginInput").value;

        // Panel visibility, position
        data.isPanelVisible = isPanelVisible;
        var panelEl = document.getElementById('frameTracker');
        data.panelLeft = panelEl.style.left;
        data.panelTop = panelEl.style.top;

        // Gather frames (avoid arrow functions & NodeList.forEach)
        var allFrames = document.querySelectorAll(".frame");
        data.frames = [];
        for (var i = 0; i < allFrames.length; i++) {
            var frame = allFrames[i];
            data.frames.push({
                id: frame.id,
                left: frame.style.left,
                top: frame.style.top,
                width: frame.style.width,
                height: frame.style.height,
                transform: frame.style.transform,
                dataOrigWidth: frame.getAttribute("data-orig-width"),
                dataOrigHeight: frame.getAttribute("data-orig-height")
            });
        }

        // Also store frameHistory (for "Undo" stack)
        data.frameHistory = frameHistory.slice();

        // Save in localStorage (via safe wrapper)
        safeSetLocalStorage("layoutData", JSON.stringify(data));
    }

    /* -----------------------------------------
       3) LOAD STATE (ES5 Style)
       ----------------------------------------- */
    function loadState() {
        var saved = safeGetLocalStorage("layoutData");
        if (!saved) {
            return; // Nothing saved yet
        }

        var data = JSON.parse(saved);

        // 1) Restore simple variables
        showAlignmentLines = data.showAlignmentLines;
        currentUnit = data.currentUnit || "inch";

        // Paper & margin
        document.getElementById("paperWidth").value = data.paperWidth || "8.5";
        document.getElementById("paperHeight").value = data.paperHeight || "11";
        document.getElementById("marginInput").value = data.marginInput || "0";

        // Re-sync the unit dropdowns
        document.getElementById("paperUnit").value = currentUnit;
        document.getElementById("frameUnit").value = currentUnit;
        document.getElementById("marginUnit").value = currentUnit;
        syncUnits(currentUnit);

        // Adjust paper size in PX
        var paperWpx = parseFloat(document.getElementById("paperWidth").value) * conversionFactors[currentUnit];
        var paperHpx = parseFloat(document.getElementById("paperHeight").value) * conversionFactors[currentUnit];
        paper.style.width = paperWpx + "px";
        paper.style.height = paperHpx + "px";

        // 2) Restore panel visibility & position
        isPanelVisible = (data.isPanelVisible !== false);
        var panelEl = document.getElementById('frameTracker');
        panelEl.style.left = data.panelLeft || "0px";
        panelEl.style.top = data.panelTop || "0px";
        if (!isPanelVisible) {
            panel.style.display = 'none';
            panel.style.opacity = '0';
            toggleButton.innerHTML = 'Show Frame Tracker';
        }

        // 3) Clear existing frames & table rows
        paper.innerHTML = "";
        frameList.innerHTML = "";
        frameHistory = [];
        frameCount = 0;

        // Rebuild frames
        if (data.frames && data.frames.length > 0) {
            for (var j = 0; j < data.frames.length; j++) {
                var frameData = data.frames[j];

                // Create the .frame div
                var frame = document.createElement("div");
                frame.className = "frame";
                frame.id = frameData.id;
                frame.style.left = frameData.left;
                frame.style.top = frameData.top;
                frame.style.width = frameData.width;
                frame.style.height = frameData.height;
                frame.style.transform = frameData.transform || "rotate(0deg)";
                frame.setAttribute("data-orig-width", frameData.dataOrigWidth);
                frame.setAttribute("data-orig-height", frameData.dataOrigHeight);

                // ID display inside the frame
                var idDisplay = document.createElement('div');
                idDisplay.className = 'frame-id-display';
                idDisplay.textContent = frameData.id;
                frame.appendChild(idDisplay);

                // Insert into the paper
                paper.appendChild(frame);

                // Make it draggable
                makeDraggable(frame);

                // Create row in the #frameList
                var row = document.createElement("tr");
                row.id = frameData.id + "-row";

                // Convert stored px back to displayed dimension
                var widthPx = parseFloat(frameData.width) || 0;
                var heightPx = parseFloat(frameData.height) || 0;
                var displayedW = (widthPx / conversionFactors[currentUnit]).toFixed(2);
                var displayedH = (heightPx / conversionFactors[currentUnit]).toFixed(2);

                // Build the row’s HTML (no template literals)
                row.innerHTML =
                    '<td class="frame-id-cell" contenteditable="true" data-frame-id="' + frameData.id + '">' + frameData.id + '</td>' +
                    '<td class="dim-cell">' + displayedW + '</td>' +
                    '<td class="dim-cell">' + displayedH + '</td>' +
                    '<td>' + currentUnit + '</td>' +
                    '<td>' +
                    '  <input type="range" min="0" max="360" value="0" data-frame-id="' + frameData.id + '" class="rotate-slider">' +
                    '  <span class="rotate-value">0°</span>' +
                    '  <div class="rotation-buttons">' +
                    '    <button class="rotate-btn" data-angle="90" data-frame-id="' + frameData.id + '">90°</button>' +
                    '    <button class="rotate-btn" data-angle="180" data-frame-id="' + frameData.id + '">180°</button>' +
                    '    <button class="rotate-btn" data-angle="270" data-frame-id="' + frameData.id + '">270°</button>' +
                    '  </div>' +
                    '</td>' +
                    '<td><button class="delete-btn" data-frame-id="' + frameData.id + '">Delete</button></td>';

                frameList.appendChild(row);

                // Attach event listeners for "Delete," "Rotate," etc.
                var deleteBtn = row.querySelector(".delete-btn");
                deleteBtn.addEventListener("click", (function(id) {
                    // Use an IIFE to capture the ID in older IE
                    return function() {
                        deleteFrame(id);
                    };
                })(frameData.id));

                // Finally, update the size display
                updateFrameSizeDisplay(frame);
            }
        }

        // 4) Restore frameHistory if needed
        frameHistory = data.frameHistory || [];

        // 5) Regenerate alignment lines if needed
        if (showAlignmentLines) {
            generateAlignmentLines();
        }
    }

    /* -----------------------------------------
       4) LOAD ON DOM READY & SAVE ON UNLOAD
       ----------------------------------------- */

    // For IE9+ we can do addEventListener("DOMContentLoaded", ...)
    document.addEventListener("DOMContentLoaded", function() {
        loadState();
        // If you want lines re-drawn after a short delay:
        setTimeout(function() {
            if (showAlignmentLines) {
                generateAlignmentLines();
            }
        }, 500);
    });

    window.addEventListener("beforeunload", function() {
        saveState();
    });
</script>
</body>
</html>



